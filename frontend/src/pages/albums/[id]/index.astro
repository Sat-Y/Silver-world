---
import type { GetStaticPaths } from "astro";
import I18nKey from "../../../i18n/i18nKey";
import { i18n } from "../../../i18n/translation";
import MainGridLayout from "../../../layouts/MainGridLayout.astro";
import type { AlbumGroup } from "../../../types/album";
import { scanAlbums } from "../../../utils/album-scanner";

export const getStaticPaths = async () => {
	const albumsData = await scanAlbums();
	return albumsData.map((album) => ({
		params: { id: album.id },
		props: { album },
	}));
};

interface Props {
	album?: AlbumGroup;
}

const { album } = Astro.props;

// 获取当前相册ID，用于客户端动态获取数据
const currentUrl = new URL(Astro.request.url);
const albumId = currentUrl.pathname.split("/").filter(Boolean).pop();
---

<MainGridLayout title={album?.title || "相册详情"} description={album?.description || album?.title || "相册详情"}>
  <div class="flex w-full rounded-[var(--radius-large)] overflow-hidden relative min-h-32">
    <div class="card-base z-10 px-9 py-6 relative w-full">
      
      <!-- 返回按钮 -->
      <div class="mb-6">
        <a 
          href="/albums/" 
          class="inline-flex items-center gap-2 text-neutral-600 dark:text-neutral-400 hover:text-[var(--primary)] transition-colors"
        >
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
          </svg>
          {i18n(I18nKey.albumsBackToList)}
        </a>
      </div>

      <!-- 存储当前相册ID，用于客户端动态获取数据 -->
      <input type="hidden" id="current-album-id" value="${albumId}" />

      <!-- 动态内容容器 -->
      <div id="album-content">
        {album ? (
          <!-- 相册内容（静态生成的数据） -->
          <>
            <!-- 相册标题信息 -->
            <header class="mb-8">
              <h1 class="text-3xl font-bold text-neutral-900 dark:text-neutral-100 mb-3">
                {album.title}
              </h1>
              
              {album.description && (
                <p class="text-neutral-600 dark:text-neutral-400 mb-4">
                  {album.description}
                </p>
              )}
              
              <!-- 相册元数据 -->
              <div class="flex flex-wrap items-center gap-4 text-sm text-neutral-500 dark:text-neutral-500">
                <span>{album.photos.length} {album.photos.length > 1 ? i18n(I18nKey.albumsPhotosCount) : i18n(I18nKey.albumsPhotoCount)}</span>
                <time>{new Date(album.date).getFullYear()}</time>
                {album.location && (
                  <span class="flex items-center gap-1">
                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                      <path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd"></path>
                    </svg>
                    {album.location}
                  </span>
                )}
              </div>
              
              <!-- 标签 -->
              {album.tags && album.tags.length > 0 && (
                <div class="flex flex-wrap gap-2 mt-4">
                  {album.tags.map(tag => (
                    <span class="btn-regular h-8 text-sm px-3 rounded-lg">
                      {tag}
                    </span>
                  ))}
                </div>
              )}
            </header>

            <!-- 照片网格 -->
            <div 
              class={`photo-gallery moment-images ${album.layout === 'masonry' ? 'masonry-layout' : 'grid-layout'}`}
              data-layout={album.layout || 'grid'}
              data-columns={album.columns || 3}
            >
              {album.photos.map((photo, index) => (
                <figure class="photo-item group relative overflow-hidden rounded-lg">
                  <a 
                    href={photo.src}
                    data-pswp-width={photo.width || 1200}
                    data-pswp-height={photo.height || 800}
                    target="_blank"
                    class="block"
                  >
                    <img 
                      src={photo.src}
                      alt={photo.alt}
                      class="photo-image w-full h-full object-cover group-hover:scale-105 transition-transform duration-300 cursor-pointer"
                      loading="lazy"
                    />
                  </a>
                </figure>
              ))}
            </div>
          </>
        ) : (
          <!-- 加载状态 -->
          <div class="text-center py-12">
            <div class="text-neutral-400 dark:text-neutral-600 mb-4">
              <svg class="w-16 h-16 mx-auto animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
              </svg>
            </div>
            <h3 class="text-lg font-medium text-neutral-900 dark:text-neutral-100 mb-2">
              加载中...
            </h3>
            <p class="text-neutral-600 dark:text-neutral-400">
              正在获取相册数据，请稍候...
            </p>
          </div>
        )}
      </div>
    </div>
  </div>

</MainGridLayout>

<script>
  const ALBUMS_STORAGE_KEY = 'mizuki_albums';

  function getStoredAlbums() {
    const stored = localStorage.getItem(ALBUMS_STORAGE_KEY);
    return stored ? JSON.parse(stored) : [];
  }

  document.addEventListener('DOMContentLoaded', async () => {
    console.log('=== 相册详情页加载完成，开始获取最新相册数据 ===');
    
    const albumIdElement = document.getElementById('current-album-id');
    let albumId = '';
    if (albumIdElement) {
      albumId = albumIdElement.value;
    }
    
    if (!albumId) {
      const currentUrl = new URL(window.location.href);
      albumId = currentUrl.pathname.split('/').filter(Boolean).pop() || '';
    }
    
    console.log('当前相册ID:', albumId);
    
    try {
      const albums = getStoredAlbums();
      const latestAlbum = albums.find(a => a.id === albumId);
      
      if (latestAlbum) {
        console.log('最新相册数据:', latestAlbum);
        
        const pageTitle = document.querySelector('title');
        if (pageTitle) {
          pageTitle.textContent = latestAlbum.title;
        }
        
        const albumContent = document.getElementById('album-content');
        if (albumContent) {
          const processedPhotos = latestAlbum.photos.map(photo => {
            console.log('原始照片URL:', photo.url || photo.src);
            let photoUrl = photo.url || photo.src;
            console.log('修复后的照片URL:', photoUrl);
            return {
              ...photo,
              src: photoUrl
            };
          }).filter(photo => photo.src);
          
          const validTags = latestAlbum.tags ? latestAlbum.tags.filter(tag => tag !== null && tag !== undefined && tag !== '') : [];
      
          albumContent.innerHTML = `
            <header class="mb-8">
              <h1 class="text-3xl font-bold text-neutral-900 dark:text-neutral-100 mb-3">
                ${latestAlbum.title}
              </h1>
              
              ${latestAlbum.description ? `
                <p class="text-neutral-600 dark:text-neutral-400 mb-4">
                  ${latestAlbum.description}
                </p>
              ` : ''}
              
              <div class="flex flex-wrap items-center gap-4 text-sm text-neutral-500 dark:text-neutral-500">
                <span>${processedPhotos.length} ${processedPhotos.length > 1 ? '照片' : '照片'}</span>
                <time>${new Date(latestAlbum.date).getFullYear()}</time>
                ${latestAlbum.location ? `
                  <span class="flex items-center gap-1">
                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                      <path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd"></path>
                    </svg>
                    ${latestAlbum.location}
                  </span>
                ` : ''}
              </div>
              
              ${validTags.length > 0 ? `
                <div class="flex flex-wrap gap-2 mt-4">
                  ${validTags.map(tag => `<span class="btn-regular h-8 text-sm px-3 rounded-lg">${tag}</span>`).join('')}
                </div>
              ` : ''}
            </header>

            <div 
              class="photo-gallery moment-images grid-layout"
              data-layout="grid"
              data-columns="3"
            >
              ${processedPhotos.map((photo, index) => `
                <figure class="photo-item group relative overflow-hidden rounded-lg">
                  <a 
                    href="${photo.src}"
                    data-pswp-width="${photo.width || 1200}"
                    data-pswp-height="${photo.height || 800}"
                    target="_blank"
                    class="block"
                  >
                    <img 
                      src="${photo.src}"
                      alt="${photo.originalName || `Photo ${index + 1}`}"
                      class="photo-image w-full h-full object-cover group-hover:scale-105 transition-transform duration-300 cursor-pointer"
                      loading="lazy"
                    />
                  </a>
                </figure>
              `).join('')}
            </div>
          `;
          
          console.log('=== 相册详情已更新 ===');
          initPhotoSwipe();
        }
      } else {
        console.error('相册不存在');
        const albumContent = document.getElementById('album-content');
        if (albumContent) {
          albumContent.innerHTML = `
            <div class="text-center py-12">
              <div class="text-neutral-400 dark:text-neutral-600 mb-4">
                <svg class="w-16 h-16 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
              </div>
              <h3 class="text-lg font-medium text-neutral-900 dark:text-neutral-100 mb-2">
                相册不存在或已被删除
              </h3>
              <p class="text-neutral-600 dark:text-neutral-400 mb-4">
                无法找到该相册的信息，请返回相册列表页。
              </p>
              <a 
                href="/albums/" 
                class="btn-primary inline-flex items-center gap-2"
              >
                返回相册列表
              </a>
            </div>
          `;
        }
      }
    } catch (error) {
      console.error('获取最新相册数据出错:', error);
      const albumContent = document.getElementById('album-content');
      if (albumContent) {
        albumContent.innerHTML = `
          <div class="text-center py-12">
            <div class="text-neutral-400 dark:text-neutral-600 mb-4">
              <svg class="w-16 h-16 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
              </svg>
            </div>
            <h3 class="text-lg font-medium text-neutral-900 dark:text-neutral-100 mb-2">
              加载失败
            </h3>
            <p class="text-neutral-600 dark:text-neutral-400 mb-4">
              获取相册数据时出现错误，请稍后重试。
            </p>
            <button 
              onclick="window.location.reload()" 
              class="btn-primary inline-flex items-center gap-2"
            >
              重新加载
            </button>
          </div>
        `;
      }
    }
  });
  
  function initPhotoSwipe() {
    console.log('=== 初始化PhotoSwipe ===');
    const albumImages = document.querySelectorAll('.moment-images img, .photo-gallery img');
    console.log('相册图片数量:', albumImages.length);
    
    albumImages.forEach((img) => {
      if (img instanceof HTMLImageElement) {
        const preloadImg = new Image();
        preloadImg.src = img.src;
      }
    });
    
    document.querySelectorAll('.photo-gallery a').forEach(link => {
      if (link instanceof HTMLAnchorElement) {
        link.addEventListener('click', (e) => {
          e.preventDefault();
        });
      }
    });
  }
</script>

<style>
  .grid-layout {
    display: grid;
    gap: 1rem;
  }
  
  .grid-layout[data-columns="2"] {
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
  }
  
  .grid-layout[data-columns="3"] {
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
  }
  
  .grid-layout[data-columns="4"] {
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  }
  
  .masonry-layout {
    columns: 2;
    column-gap: 1rem;
  }
  
  @media (min-width: 768px) {
    .masonry-layout {
      columns: 3;
    }
  }
  
  @media (min-width: 1024px) {
    .masonry-layout[data-columns="4"] {
      columns: 4;
    }
  }
  
  .masonry-layout .photo-item {
    break-inside: avoid;
    margin-bottom: 1rem;
  }
  
  .grid-layout .photo-container {
    aspect-ratio: 1;
  }
  
</style>

